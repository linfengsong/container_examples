variables:
  GITLAB_UTILS_PATH: "gitlab_utils"

load_gitlab_utils_job:
  stage: .pre
  image: $BUILDER_IMAGE_UBI8PLUS
  script:
    - |
      echo "Load gitlab utils start"
      srcPath=$(pwd)
      
      #git config --global http:sslVerify false
      #git clone https://linfeng.sone/builder-images.git
      #ls -l
      
      echo curl -L --header "$GITLAB_UTILS_ACCESS_TOKEN" "$GITLAB_UTILS_URL" -o 'archive.tar'
      curl -L --header 'PRIVATE-TOKEN: glpat-W2z5-4YTb6CcnrLoijtU' 'http://lenovo:50080/api/v4/projects/8/repository/archive.tar?ref=master' -o 'archive.tar'
      tar xf archive.tar
      if [[ $? -ne 0 ]]; then
        cat archive.tar
        exit 1
      fi
      gitlab_utils_master_path=gitlab-utils-master
      mkdir -p $GITLAB_UTILS_PATH
      cp -R $gitlab_utils_master_path-*/* $GITLAB_UTILS_PATH/
      
      echo CI_APP=$CI_APP
      echo CD_BCP_APP=$CD_BCP_APP
      echo CD_BCP_APP_TRIGGER=$CD_BCP_APP_TRIGGER

      chmod 755 $GITLAB_UTILS_PATH/script/config.sh
      if [[ ! -z $CI_APP ]]; then
        echo $GITLAB_UTILS_PATH/script/config.sh $(pwd) $ENV_NAME -ci $CI_APP
        $GITLAB_UTILS_PATH/script/config.sh $(pwd) $ENV_NAME -ci $CI_APP
      fi
      
      if [[ ! -z $CD_BCP_APP_TRIGGER ]] && [[ ! "$CD_BCP_APP_TRIGGER" == "ALL" ]]; then
        echo $GITLAB_UTILS_PATH/script/config.sh $(pwd) $ENV_NAME -cd_bcp $CD_BCP_APP_TRIGGER
        $GITLAB_UTILS_PATH/script/config.sh $(pwd) $ENV_NAME -cd_bcp $CD_BCP_APP_TRIGGER
      elif [[ ! -z "$CD_BCP_APPS" ]]; then
        for i in ${CD_BCP_APPS//,/ }; do
          echo $GITLAB_UTILS_PATH/script/config.sh $(pwd) $ENV_NAME -cd_bcp $i
          $GITLAB_UTILS_PATH/script/config.sh $(pwd) $ENV_NAME -cd_bcp $i
        done
      elif [[ ! -z "$CD_BCP_APP" ]]; then
        echo $GITLAB_UTILS_PATH/script/config.sh $(pwd) $ENV_NAME -cd_bcp $CD_BCP_APP
        $GITLAB_UTILS_PATH/script/config.sh $(pwd) $ENV_NAME -cd_bcp $CD_BCP_APP      
      fi
      
      if [[ -d gitlab_utils/ci/apps ]]; then
        echo ls -l gitlab_utils/ci/apps
        ls -l gitlab_utils/ci/apps
      fi
      if [[ -d gitlab_utils/cd_bcp/apps ]]; then
        echo ls -l gitlab_utils/cd_bcp/apps
        ls -l gitlab_utils/cd_bcp/apps
      fi
      echo "Load gitlab utils finish"
  artifacts:
    paths:
      - gitlab_utils
    expire_in: 1 day
